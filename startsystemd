#!/bin/sh

LOGFILE=~/startsystemd.log
function log() {
    # Uncomment the following line to enable logging for debugging purposes
    #echo "["$(date '+%F %T')"] "$@ >> ${LOGFILE}
    true
}

rm ${LOGFILE}

# reset the session environment file
log "Removing session environment file"
rm ${SESSION_ENV_FILE}
log "Touching session environment file"
touch ${SESSION_ENV_FILE}

# import selected session environment variables into the systemd user
# environment
log "Importing existing environment variables"
for ENV_VAR in DBUS_SESSION_BUS_ADDRESS \
               DESKTOP_SESSION \
               DISPLAY \
               XAUTHORITY \
               SESSION_MANAGER \
               XDG_CONFIG_DIRS \
               XDG_DATA_DIRS \
               XDG_RUNTIME_DIR \
               XDG_SEAT_PATH \
               XDG_SEAT \
               XDG_SESSION_CLASS \
               XDG_SESSION_ID \
               XDG_SESSION_PATH \
               XDG_SESSION_TYPE \
               XDG_VTNR;
do
    systemctl --user import-environment ${ENV_VAR}
done

# set selected session environment variables in the systemd user environment
log "Setting new environment variables"
for KEY_VAL in KDE_FULL_SESSION=true \
               XDG_CURRENT_DESKTOP=KDE \
               XDG_SESSION_DESKTOP=KDE \
               KDE_SESSION_VERSION=5;
do
    systemctl --user set-environment ${KEY_VAL}
done

# before anything else happens, dbus.service needs to be restarted
# otherwise any application which might be later started via dbus activation
# won't see any of the environment variables we imported into the systemd
# user environment
log "Restarting dbus.service"
systemctl --user restart dbus.service

# if plasma-workspace.target is not enabled bail out
log "Checking availability of plasma-workspace.target"
systemctl --user is-enabled plasma-workspace.target || { xmessage "Please enable plasma-workspace.target"; exit 1; }

#systemctl --user start kwin.service
log "Starting plasma-workspace.target"
systemctl --user start plasma-workspace.target

#now lets wait and watch beautiful plasma
read
